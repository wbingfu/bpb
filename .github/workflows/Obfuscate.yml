name: Build Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out your code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"  # ä½¿ç”¨è¾ƒæ–°ç‰ˆæœ¬çš„ Node ä»¥æ”¯æŒæ„å»ºå·¥å…·

      - name: Install Obfuscator
        run: |
          npm install -g javascript-obfuscator

      - name: Build from Upstream
        run: |
          echo "ğŸš€ Cloning upstream repository..."
          git clone https://github.com/bia-pain-bache/BPB-Worker-Panel.git build_temp
          
          cd build_temp
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          
          echo "ğŸ› ï¸ Building project..."
          # è¿™é‡Œå°è¯•è¿è¡Œæ„å»ºå‘½ä»¤ï¼Œé€šå¸¸æ˜¯ npm run build
          # æ„å»ºä¼šå°†é«˜çº§è¯­æ³•è½¬æ¢ä¸ºæ ‡å‡† JS
          npm run build
          
          echo "ğŸ” Finding the built file..."
          # æ„å»ºåçš„æ–‡ä»¶é€šå¸¸åœ¨ dist ç›®å½•ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒ
          # å¸¸è§çš„æ„å»ºè¾“å‡ºæ–‡ä»¶åä¸º _worker.js, index.js æˆ– worker.js
          if [ -f "dist/index.js" ]; then
            BUILT_FILE="dist/index.js"
          elif [ -f "dist/worker.js" ]; then
            BUILT_FILE="dist/worker.js"
          elif [ -f "dist/_worker.js" ]; then
            BUILT_FILE="dist/_worker.js"
          else
            # æš´åŠ›æœç´¢ dist ç›®å½•ä¸‹çš„ js æ–‡ä»¶
            BUILT_FILE=$(find dist -name "*.js" | head -n 1)
          fi
          
          if [ -z "$BUILT_FILE" ]; then
            echo "âŒ Build failed or output not found!"
            ls -R dist
            exit 1
          fi

          echo "âœ… Found built file: $BUILT_FILE"
          
          # å°†æ„å»ºå¥½çš„æ–‡ä»¶å¤åˆ¶å›ä¸Šä¸€çº§ç›®å½•çš„ origin.js
          cp "$BUILT_FILE" ../origin.js
          
          cd ..
          rm -rf build_temp
          echo "ğŸ‰ Ready to obfuscate!"

      - name: Obfuscate BPB worker js
        run: |
          # ç°åœ¨çš„ origin.js æ˜¯ç»è¿‡ç¼–è¯‘çš„æ ‡å‡†ä»£ç ï¼Œä¸ä¼šå†æŠ¥é”™äº†
          javascript-obfuscator origin.js --output _worker.js \
          --compact true \
          --control-flow-flattening true \
          --control-flow-flattening-threshold 1 \
          --dead-code-injection true \
          --dead-code-injection-threshold 1 \
          --identifier-names-generator hexadecimal \
          --rename-globals true \
          --string-array true \
          --string-array-encoding 'rc4' \
          --string-array-threshold 1 \
          --transform-object-keys true \
          --unicode-escape-sequence true

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ':arrow_up: update latest bpb panel'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
